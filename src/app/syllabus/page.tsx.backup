'use client';

import React, { useState, useEffect } from 'react';
import styles from './page.module.css';
import {
    Plus,
    Trash2,
    ArrowRightCircle,
    CheckCircle2,
    Circle,
    BookOpen
} from 'lucide-react';
import { PieChart, Pie, Cell, ResponsiveContainer } from 'recharts';

// --- Types ---

interface Chapter {
    id: string;
    name: string;
    completed: boolean;
    lastPushedGoalId?: string;
    lastPushedDate?: string; // Format: YYYY-MM-DD
}

interface Subject {
    id: string;
    name: string;
    chapters: Chapter[];
}

// Copied/Compatible with page.tsx Block interface
interface Block {
    id: string;
    type: 'text' | 'todo';
    content: string;
    completed: boolean;
    source?: 'daily' | 'weekly' | 'monthly' | 'syllabus';
    parentId?: string;
    chapterId?: string; // Link back to syllabus
}

type DailyGoals = {
    [date: string]: Block[];
};

// --- Constants ---

const COLORS = ['#10b981', '#e2e8f0']; // Completed (Green), Remaining (Gray)

import { useGamification } from '@/hooks/useGamification';

export default function SyllabusPage() {
    const [subjects, setSubjects] = useState<Subject[]>([]);
    const [newSubjectName, setNewSubjectName] = useState('');
    const [newChapterNames, setNewChapterNames] = useState<{ [subjectId: string]: string }>({});
    const [mounted, setMounted] = useState(false);

    const { checkAchievements = () => { } } = useGamification() || {};

    // --- Helpers ---

    const generateId = () => Math.random().toString(36).substr(2, 9);

    const getDateKey = (date: Date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    // --- Effects ---

    // Load initial data
    useEffect(() => {
        const savedSyllabus = localStorage.getItem('syllabus');
        if (savedSyllabus) {
            try {
                setSubjects(JSON.parse(savedSyllabus));
            } catch (e) {
                console.error('Failed to parse syllabus:', e);
            }
        }
        setMounted(true);
    }, []);

    // Save syllabus when changed
    useEffect(() => {
        if (mounted) {
            localStorage.setItem('syllabus', JSON.stringify(subjects));
        }
    }, [subjects, mounted]);

    // Listen for changes in daily goals to sync completion status
    useEffect(() => {
        const handleStorageChange = (e: Event) => {
            const customEvent = e as CustomEvent;
            if (customEvent.detail?.key === 'dailyGoals') {
                syncWithDailyGoals();
            }
        };

        window.addEventListener('localStorageChange', handleStorageChange);
        window.addEventListener('focus', syncWithDailyGoals);

        return () => {
            window.removeEventListener('localStorageChange', handleStorageChange);
            window.removeEventListener('focus', syncWithDailyGoals);
        };
    }, [subjects]);

    const syncWithDailyGoals = () => {
        const dailyData = localStorage.getItem('dailyGoals');
        if (!dailyData) return;

        try {
            const dailyGoals: DailyGoals = JSON.parse(dailyData);
            let hasChanges = false;

            const newSubjects = subjects.map(subject => {
                const newChapters = subject.chapters.map(chapter => {
                    if (chapter.lastPushedGoalId && chapter.lastPushedDate) {
                        const goalsForDate = dailyGoals[chapter.lastPushedDate] || [];
                        const goal = goalsForDate.find(g => g.id === chapter.lastPushedGoalId);

                        if (goal) {
                            if (chapter.completed !== goal.completed) {
                                hasChanges = true;
                                return { ...chapter, completed: goal.completed };
                            }
                        }
                    }
                    return chapter;
                });
                return { ...subject, chapters: newChapters };
            });

            if (hasChanges) {
                setSubjects(newSubjects);
            }
        } catch (e) {
            console.error('Failed to sync with daily goals:', e);
        }
    };

    // --- Actions ---

    const addSubject = () => {
        if (!newSubjectName.trim()) return;
        const newSubject: Subject = {
            id: generateId(),
            name: newSubjectName,
            chapters: []
        };
        setSubjects([...subjects, newSubject]);
        setNewSubjectName('');
        // checkAchievements('start_subject', { subjectId: newSubject.id });
    };

    const deleteSubject = (id: string) => {
        if (confirm('Are you sure you want to delete this subject?')) {
            setSubjects(subjects.filter(s => s.id !== id));
        }
    };

    const addChapter = (subjectId: string) => {
        const name = newChapterNames[subjectId];
        if (!name?.trim()) return;

        const newChapter: Chapter = {
            id: generateId(),
            name: name,
            completed: false
        };

        setSubjects(subjects.map(s => {
            if (s.id === subjectId) {
                return { ...s, chapters: [...s.chapters, newChapter] };
            }
            return s;
        }));

        setNewChapterNames({ ...newChapterNames, [subjectId]: '' });
    };

    const deleteChapter = (subjectId: string, chapterId: string) => {
        setSubjects(subjects.map(s => {
            if (s.id === subjectId) {
                return { ...s, chapters: s.chapters.filter(c => c.id !== chapterId) };
            }
            return s;
        }));
    };

    const toggleChapterCompletion = (subjectId: string, chapter: Chapter) => {
        const newCompleted = !chapter.completed;

        // Update Syllabus State
        setSubjects(subjects.map(s => {
            if (s.id === subjectId) {
                return {
                    ...s,
                    chapters: s.chapters.map(c => {
                        if (c.id === chapter.id) {
                            return { ...c, completed: newCompleted };
                        }
                        return c;
                    })
                };
            }
            return s;
        }));

        // Sync with Daily Goal if it exists
        if (chapter.lastPushedGoalId && chapter.lastPushedDate) {
            const dailyData = localStorage.getItem('dailyGoals');
            if (dailyData) {
                try {
                    const dailyGoals: DailyGoals = JSON.parse(dailyData);
                    const goalsForDate = dailyGoals[chapter.lastPushedDate];

                    if (goalsForDate) {
                        const goalIndex = goalsForDate.findIndex(g => g.id === chapter.lastPushedGoalId);
                        if (goalIndex !== -1) {
                            goalsForDate[goalIndex].completed = newCompleted;
                            dailyGoals[chapter.lastPushedDate] = goalsForDate;

                            localStorage.setItem('dailyGoals', JSON.stringify(dailyGoals));
                            window.dispatchEvent(new CustomEvent('localStorageChange', { detail: { key: 'dailyGoals' } }));
                        }
                    }
                } catch (e) {
                    console.error('Failed to sync toggle with daily goals:', e);
                }
            }
        }

        if (newCompleted) {
            // checkAchievements('complete_chapter');
        }
    };

    const pushToToday = (subjectId: string, chapter: Chapter) => {
        const todayKey = getDateKey(new Date());
        const dailyData = localStorage.getItem('dailyGoals');
        let dailyGoals: DailyGoals = {};

        if (dailyData) {
            try {
                dailyGoals = JSON.parse(dailyData);
            } catch (e) {
                console.error(e);
            }
        }

        const newGoalId = generateId();
        const newBlock: Block = {
            id: newGoalId,
            type: 'todo',
            content: `${chapter.name} (${subjects.find(s => s.id === subjectId)?.name})`,
            completed: false,
            source: 'daily',
            chapterId: chapter.id
        };

        const todayGoals = dailyGoals[todayKey] || [];
        dailyGoals[todayKey] = [...todayGoals, newBlock];

        // Save Daily Goals
        localStorage.setItem('dailyGoals', JSON.stringify(dailyGoals));
        window.dispatchEvent(new CustomEvent('localStorageChange', { detail: { key: 'dailyGoals' } }));

        // Update Syllabus State
        setSubjects(subjects.map(s => {
            if (s.id === subjectId) {
                return {
                    ...s,
                    chapters: s.chapters.map(c => {
                        if (c.id === chapter.id) {
                            return {
                                ...c,
                                completed: false, // Reset completion
                                lastPushedGoalId: newGoalId,
                                lastPushedDate: todayKey
                            };
                        }
                        return c;
                    })
                };
            }
            return s;
        }));
    };

    // --- Calculations ---

    const getTotalStats = () => {
        let total = 0;
        let completed = 0;
        subjects.forEach(s => {
            total += s.chapters.length;
            completed += s.chapters.filter(c => c.completed).length;
        });
        return { total, completed, percentage: total === 0 ? 0 : Math.round((completed / total) * 100) };
    };

    const getSubjectStats = (subject: Subject) => {
        const total = subject.chapters.length;
        const completed = subject.chapters.filter(c => c.completed).length;
        return { total, completed, percentage: total === 0 ? 0 : Math.round((completed / total) * 100) };
    };

    const totalStats = getTotalStats();
    const pieData = [
        { name: 'Completed', value: totalStats.completed },
        { name: 'Remaining', value: totalStats.total - totalStats.completed }
    ];

    if (!mounted) return null;

    return (
        <div className={styles.container}>
            <header className={styles.header}>
                <div>
                    <h1 className={styles.title}>Syllabus Tracker</h1>
                    <p className={styles.subtitle}>Manage your subjects and track your progress</p>
                </div>
            </header>

            {/* Overall Progress */}
            <section className={styles.overview}>
                <div className={styles.chartContainer}>
                    <ResponsiveContainer width="100%" height="100%">
                        <PieChart>
                            <Pie
                                data={pieData}
                                innerRadius={60}
                                outerRadius={80}
                                paddingAngle={5}
                                dataKey="value"
                                stroke="none"
                            >
                                {pieData.map((entry, index) => (
                                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                ))}
                            </Pie>
                        </PieChart>
                    </ResponsiveContainer>
                    <div className={styles.chartLabel}>
                        <div className={styles.chartLabelValue}>{totalStats.percentage}%</div>
                        <div className={styles.chartLabelText}>Done</div>
                    </div>
                </div>

                <div className={styles.stats}>
                    <div className={styles.statItem}>
                        <span className={styles.statValue}>{totalStats.completed}</span>
                        <span className={styles.statLabel}>Chapters Completed</span>
                    </div>
                    <div className={styles.statItem}>
                        <span className={styles.statValue}>{totalStats.total}</span>
                        <span className={styles.statLabel}>Total Chapters</span>
                    </div>
                    <div className={styles.statItem}>
                        <span className={styles.statValue}>{subjects.length}</span>
                        <span className={styles.statLabel}>Subjects</span>
                    </div>
                </div>
            </section>

            {/* Subjects Grid */}
            <div className={styles.grid}>
                {subjects.map(subject => {
                    const stats = getSubjectStats(subject);
                    const subjectPieData = [
                        { name: 'Completed', value: stats.completed },
                        { name: 'Remaining', value: stats.total - stats.completed }
                                            onClick = {() => toggleChapterCompletion(subject.id, chapter)}
                style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}
                                        >
                {chapter.completed ? <CheckCircle2 size={18} /> : <Circle size={18} />}
            </button>
            <span className={styles.chapterName}>{chapter.name}</span>
            <button
                onClick={() => pushToToday(subject.id, chapter)}
                className={styles.pushButton}
                title="Push to Today's Goals"
            >
                <ArrowRightCircle size={18} />
            </button>
            <button
                onClick={() => deleteChapter(subject.id, chapter.id)}
                className={styles.pushButton}
                style={{ opacity: 0.5 }}
                title="Delete Chapter"
            >
                <Trash2 size={14} />
            </button>
        </div>
    ))
}
                            </div >

    <div className={styles.addChapter}>
        <input
            type="text"
            placeholder="New chapter name..."
            className={styles.input}
            value={newChapterNames[subject.id] || ''}
            onChange={(e) => setNewChapterNames({ ...newChapterNames, [subject.id]: e.target.value })}
            onKeyDown={(e) => e.key === 'Enter' && addChapter(subject.id)}
        />
        <button onClick={() => addChapter(subject.id)} className={styles.addButton}>
            <Plus size={18} />
        </button>
    </div>
                        </div >
                    );
                })}

{/* Add Subject Card */ }
<div className={styles.subjectCard} style={{ borderStyle: 'dashed', justifyContent: 'center', alignItems: 'center' }}>
    <div className={styles.addSubjectCard} onClick={() => document.getElementById('newSubjectInput')?.focus()}>
        <div style={{ width: '100%', padding: '1rem' }}>
            <input
                id="newSubjectInput"
                type="text"
                placeholder="Enter subject name..."
                className={styles.input}
                style={{ textAlign: 'center', marginBottom: '1rem' }}
                value={newSubjectName}
                onChange={(e) => setNewSubjectName(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && addSubject()}
            />
            <button
                onClick={addSubject}
                className={styles.addButton}
                style={{ width: '100%' }}
            >
                <Plus size={18} style={{ marginRight: '0.5rem' }} />
                Add New Subject
            </button>
        </div>
    </div>
</div>
            </div >
        </div >
    );
}
